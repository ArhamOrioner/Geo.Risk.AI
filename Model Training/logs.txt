STATIC + DYNAMIC ENSEMBLE
============================================================

============================================================
LOADING DATA
============================================================
Found 1 CSV files
Combined shape: (17382, 57)

Class distribution (target_future):
target_future
0.0    9064
1.0    8089
Name: count, dtype: int64

============================================================
STAGE 1: 80/20 validation multi-cycle search
============================================================

Warning: 7 features missing

Applying zero-to-NaN conversion for invalid zeros...
Replaced 2,225 invalid zeros with NaN

Train: (13722, 36) | Test: (3431, 36)
Train class balance: {0: 7251, 1: 6471}

Feature variability partition summary:
  Static cutoff (CV ≤ 1.0900), Dynamic cutoff (CV ≥ 1.7167)
  Highest-variability (dynamic) features:
    • gee_flashiness_index_7d: CV=32.0341
    • glofas_forecast_10th_percentile: CV=5.7927
    • glofas_forecast_median: CV=5.7627
    • glofas_forecast_control: CV=5.7548
    • glofas_forecast_mean: CV=5.7520
  Lowest-variability (static) features:
    • gee_aspect_mean: CV=0.2247
    • gee_gsw_occurrence_mean: CV=0.3418
    • gee_ndvi_mean_30d: CV=0.3636
    • gee_twi: CV=0.3759
    • gee_smap_subsurface_soil_moisture: CV=0.3781
Static features (auto + overrides): 17
Dynamic features (auto + overrides): 19
Static feature list (with ordering preserved):
   1. gee_api_weighted_mm
   2. gee_aspect_mean
   3. gee_elevation_mean
   4. gee_flashiness_index
   5. gee_gsw_occurrence_mean
   6. gee_imerg_intensity_7d_mm_per_day
   7. gee_imerg_max_daily_7d_mm
   8. gee_imerg_sum_7d_before_mm
   9. gee_merit_upa_mean
  10. gee_ndbi_mean_30d
  11. gee_ndvi_mean_30d
  12. gee_ndwi_mean_30d
  13. gee_saturation_proxy
  14. gee_slope_mean
  15. gee_smap_subsurface_soil_moisture
  16. gee_smap_surface_soil_moisture
  17. gee_twi
Dynamic feature list (with ordering preserved):
   1. gee_antecedent_moisture_proxy
   2. gee_flashiness_index_7d
   3. gee_imerg_intensity_3d_mm_per_day
   4. gee_imerg_max_1h_intensity_mm
   5. gee_imerg_max_3h_intensity_mm
   6. gee_imerg_max_6h_intensity_mm
   7. gee_imerg_sum_24h_mm
   8. gee_imerg_sum_3d_before_mm
   9. gee_precip_x_slope
  10. gee_runoff_potential
  11. gee_smap_soil_moisture_anomaly
  12. glofas_forecast_10th_percentile
  13. glofas_forecast_90th_percentile
  14. glofas_forecast_control
  15. glofas_forecast_mean
  16. glofas_forecast_median
  17. glofas_forecast_std_dev
  18. imerg_max_1h_intensity_mm
  19. imerg_mean_1h_intensity_mm
Class imbalance ratio (Stage 1 train): 1.12

------------------------------------------------------------
Stage 1 Cycle 1 (Cat:static | XGB:dynamic | LGB:full)
------------------------------------------------------------
CatBoost uses static features (17 columns)
XGBoost uses dynamic features (19 columns)
LightGBM uses full features (36 columns)

============================================================
TRAINING: CatBoost (static) - stage1-cycle1
============================================================
Running cross-validation (5 folds)...

Cross-Validation Results (5 folds):
  ROC-AUC:   0.7821 ± 0.0111
  Recall:    0.7259 ± 0.0113
  Precision: 0.6857 ± 0.0046
  Balanced Acc: 0.7145 ± 0.0056
  MCC:       0.4283 ± 0.0113
  -(FP+FN):  -785.4000 ± 14.9265
  F1.0 Score: 0.7052 ± 0.0069
  F1.5 Score: 0.7130 ± 0.0084
  F2.0 Score: 0.7174 ± 0.0094
  F2.5 Score: 0.7200 ± 0.0100
  F3.0 Score: 0.7216 ± 0.0103

Generating out-of-fold predictions and fitting isotonic calibrator...

Test Set Results (threshold=0.46 minimizing FP+FN):
  ROC-AUC:        0.7990
  Balanced Acc:   0.7327
  MCC:            0.4693
  Total Error:    906
  Precision:      0.7412  Recall: 0.6761
  Confusion Matrix (Test): TP=1094  FP=382  TN=1431  FN=524
  Rates: TPR=0.6761  TNR=0.7893  FPR=0.2107  FNR=0.3239
  Brier:          0.1819  Log-loss: 0.5442

============================================================
TRAINING: XGBoost (dynamic) - stage1-cycle1
============================================================
Running cross-validation (5 folds)...

Cross-Validation Results (5 folds):
  ROC-AUC:   0.6916 ± 0.0130
  Recall:    0.6778 ± 0.0256
  Precision: 0.6023 ± 0.0106
  Balanced Acc: 0.6393 ± 0.0138
  MCC:       0.2787 ± 0.0281
  -(FP+FN):  -996.0000 ± 36.3387
  F1.0 Score: 0.6377 ± 0.0166
  F1.5 Score: 0.6525 ± 0.0198
  F2.0 Score: 0.6612 ± 0.0217
  F2.5 Score: 0.6662 ± 0.0229
  F3.0 Score: 0.6694 ± 0.0236

Generating out-of-fold predictions and fitting isotonic calibrator...

Test Set Results (threshold=0.43 minimizing FP+FN):
  ROC-AUC:        0.7036
  Balanced Acc:   0.6494
  MCC:            0.2991
  Total Error:    1211
  Precision:      0.6111  Recall: 0.6916
  Confusion Matrix (Test): TP=1119  FP=712  TN=1101  FN=499
  Rates: TPR=0.6916  TNR=0.6073  FPR=0.3927  FNR=0.3084
  Brier:          0.2179  Log-loss: 0.6281

============================================================
TRAINING: LightGBM (full) - stage1-cycle1
============================================================
Running cross-validation (5 folds)...

Cross-Validation Results (5 folds):
  ROC-AUC:   0.7741 ± 0.0144
  Recall:    0.7184 ± 0.0177
  Precision: 0.6794 ± 0.0127
  Balanced Acc: 0.7079 ± 0.0135
  MCC:       0.4152 ± 0.0269
  -(FP+FN):  -803.2000 ± 36.4513
  F1.0 Score: 0.6983 ± 0.0146
  F1.5 Score: 0.7059 ± 0.0157
  F2.0 Score: 0.7102 ± 0.0163
  F2.5 Score: 0.7128 ± 0.0168
  F3.0 Score: 0.7143 ± 0.0170

Generating out-of-fold predictions and fitting isotonic calibrator...

Test Set Results (threshold=0.49 minimizing FP+FN):
  ROC-AUC:        0.7976
  Balanced Acc:   0.7264
  MCC:            0.4522
  Total Error:    940
  Precision:      0.6999  Recall: 0.7336
  Confusion Matrix (Test): TP=1187  FP=509  TN=1304  FN=431
  Rates: TPR=0.7336  TNR=0.7192  FPR=0.2808  FNR=0.2664
  Brier:          0.1835  Log-loss: 0.5459

Ensemble summary for Cycle 1 (Cat:static | XGB:dynamic | LGB:full)
  CatBoost weight: 0.45
  XGBoost weight:  0.05
  LightGBM weight:0.50
  Threshold: 0.51
  FP+FN: 873.0 | MCC: 0.489 | Brier: 0.179

------------------------------------------------------------
Stage 1 Cycle 2 (Cat:dynamic | XGB:full | LGB:static)
------------------------------------------------------------
CatBoost uses dynamic features (19 columns)
XGBoost uses full features (36 columns)
LightGBM uses static features (17 columns)

============================================================
TRAINING: CatBoost (dynamic) - stage1-cycle2
============================================================
Running cross-validation (5 folds)...

Cross-Validation Results (5 folds):
  ROC-AUC:   0.7000 ± 0.0103
  Recall:    0.6222 ± 0.0149
  Precision: 0.6212 ± 0.0092
  Balanced Acc: 0.6418 ± 0.0096
  MCC:       0.2836 ± 0.0191
  -(FP+FN):  -980.0000 ± 25.7391
  F1.0 Score: 0.6216 ± 0.0116
  F1.5 Score: 0.6218 ± 0.0128
  F2.0 Score: 0.6219 ± 0.0135
  F2.5 Score: 0.6220 ± 0.0140
  F3.0 Score: 0.6220 ± 0.0142

Generating out-of-fold predictions and fitting isotonic calibrator...

Test Set Results (threshold=0.50 minimizing FP+FN):
  ROC-AUC:        0.7224
  Balanced Acc:   0.6583
  MCC:            0.3186
  Total Error:    1162
  Precision:      0.6516  Recall: 0.6057
  Confusion Matrix (Test): TP=980  FP=524  TN=1289  FN=638
  Rates: TPR=0.6057  TNR=0.7110  FPR=0.2890  FNR=0.3943
  Brier:          0.2123  Log-loss: 0.6155

============================================================
TRAINING: XGBoost (full) - stage1-cycle2
============================================================
Running cross-validation (5 folds)...

Cross-Validation Results (5 folds):
  ROC-AUC:   0.7601 ± 0.0179
  Recall:    0.7439 ± 0.0202
  Precision: 0.6533 ± 0.0140
  Balanced Acc: 0.6959 ± 0.0158
  MCC:       0.3922 ± 0.0317
  -(FP+FN):  -842.2000 ± 42.7165
  F1.0 Score: 0.6957 ± 0.0163
  F1.5 Score: 0.7135 ± 0.0176
  F2.0 Score: 0.7238 ± 0.0184
  F2.5 Score: 0.7300 ± 0.0189
  F3.0 Score: 0.7337 ± 0.0193

Generating out-of-fold predictions and fitting isotonic calibrator...

Test Set Results (threshold=0.45 minimizing FP+FN):
  ROC-AUC:        0.7731
  Balanced Acc:   0.7062
  MCC:            0.4129
  Total Error:    1018
  Precision:      0.6623  Recall: 0.7565
  Confusion Matrix (Test): TP=1224  FP=624  TN=1189  FN=394
  Rates: TPR=0.7565  TNR=0.6558  FPR=0.3442  FNR=0.2435
  Brier:          0.1939  Log-loss: 0.5697

============================================================
TRAINING: LightGBM (static) - stage1-cycle2
============================================================
Running cross-validation (5 folds)...

Cross-Validation Results (5 folds):
  ROC-AUC:   0.7820 ± 0.0120
  Recall:    0.7320 ± 0.0155
  Precision: 0.6845 ± 0.0107
  Balanced Acc: 0.7153 ± 0.0092
  MCC:       0.4301 ± 0.0184
  -(FP+FN):  -783.8000 ± 25.3712
  F1.0 Score: 0.7074 ± 0.0097
  F1.5 Score: 0.7166 ± 0.0113
  F2.0 Score: 0.7219 ± 0.0126
  F2.5 Score: 0.7250 ± 0.0134
  F3.0 Score: 0.7269 ± 0.0139

Generating out-of-fold predictions and fitting isotonic calibrator...

Test Set Results (threshold=0.52 minimizing FP+FN):
  ROC-AUC:        0.7968
  Balanced Acc:   0.7276
  MCC:            0.4678
  Total Error:    914
  Precision:      0.7687  Recall: 0.6224
  Confusion Matrix (Test): TP=1007  FP=303  TN=1510  FN=611
  Rates: TPR=0.6224  TNR=0.8329  FPR=0.1671  FNR=0.3776
  Brier:          0.1830  Log-loss: 0.5465

Ensemble summary for Cycle 2 (Cat:dynamic | XGB:full | LGB:static)
  CatBoost weight: 0.15
  XGBoost weight:  0.10
  LightGBM weight:0.75
  Threshold: 0.53
  FP+FN: 905.0 | MCC: 0.472 | Brier: 0.182

------------------------------------------------------------
Stage 1 Cycle 3 (Cat:full | XGB:static | LGB:dynamic)
------------------------------------------------------------
CatBoost uses full features (36 columns)
XGBoost uses static features (17 columns)
LightGBM uses dynamic features (19 columns)

============================================================
TRAINING: CatBoost (full) - stage1-cycle3
============================================================
Running cross-validation (5 folds)...

Cross-Validation Results (5 folds):
  ROC-AUC:   0.7806 ± 0.0130
  Recall:    0.7153 ± 0.0171
  Precision: 0.6849 ± 0.0125
  Balanced Acc: 0.7108 ± 0.0124
  MCC:       0.4210 ± 0.0247
  -(FP+FN):  -794.4000 ± 33.6497
  F1.0 Score: 0.6997 ± 0.0134
  F1.5 Score: 0.7056 ± 0.0145
  F2.0 Score: 0.7090 ± 0.0154
  F2.5 Score: 0.7110 ± 0.0159
  F3.0 Score: 0.7122 ± 0.0162

Generating out-of-fold predictions and fitting isotonic calibrator...

Test Set Results (threshold=0.49 minimizing FP+FN):
  ROC-AUC:        0.8028
  Balanced Acc:   0.7276
  MCC:            0.4586
  Total Error:    924
  Precision:      0.7338  Recall: 0.6731
  Confusion Matrix (Test): TP=1089  FP=395  TN=1418  FN=529
  Rates: TPR=0.6731  TNR=0.7821  FPR=0.2179  FNR=0.3269
  Brier:          0.1815  Log-loss: 0.5412

============================================================
TRAINING: XGBoost (static) - stage1-cycle3
============================================================
Running cross-validation (5 folds)...

Cross-Validation Results (5 folds):
  ROC-AUC:   0.7650 ± 0.0138
  Recall:    0.7535 ± 0.0179
  Precision: 0.6541 ± 0.0106
  Balanced Acc: 0.6990 ± 0.0123
  MCC:       0.3989 ± 0.0248
  -(FP+FN):  -834.6000 ± 33.0651
  F1.0 Score: 0.7003 ± 0.0129
  F1.5 Score: 0.7198 ± 0.0145
  F2.0 Score: 0.7313 ± 0.0156
  F2.5 Score: 0.7380 ± 0.0162
  F3.0 Score: 0.7422 ± 0.0167

Generating out-of-fold predictions and fitting isotonic calibrator...

Test Set Results (threshold=0.45 minimizing FP+FN):
  ROC-AUC:        0.7691
  Balanced Acc:   0.7064
  MCC:            0.4134
  Total Error:    1017
  Precision:      0.6627  Recall: 0.7565
  Confusion Matrix (Test): TP=1224  FP=623  TN=1190  FN=394
  Rates: TPR=0.7565  TNR=0.6564  FPR=0.3436  FNR=0.2435
  Brier:          0.1949  Log-loss: 0.5734

============================================================
TRAINING: LightGBM (dynamic) - stage1-cycle3
============================================================
Running cross-validation (5 folds)...

Cross-Validation Results (5 folds):
  ROC-AUC:   0.6843 ± 0.0116
  Recall:    0.6141 ± 0.0183
  Precision: 0.6043 ± 0.0057
  Balanced Acc: 0.6277 ± 0.0077
  MCC:       0.2553 ± 0.0151
  -(FP+FN):  -1019.6000 ± 19.4499
  F1.0 Score: 0.6091 ± 0.0116
  F1.5 Score: 0.6110 ± 0.0141
  F2.0 Score: 0.6121 ± 0.0156
  F2.5 Score: 0.6127 ± 0.0164
  F3.0 Score: 0.6131 ± 0.0170

Generating out-of-fold predictions and fitting isotonic calibrator...

Test Set Results (threshold=0.53 minimizing FP+FN):
  ROC-AUC:        0.7088
  Balanced Acc:   0.6457
  MCC:            0.3004
  Total Error:    1193
  Precision:      0.6651  Recall: 0.5290
  Confusion Matrix (Test): TP=856  FP=431  TN=1382  FN=762
  Rates: TPR=0.5290  TNR=0.7623  FPR=0.2377  FNR=0.4710
  Brier:          0.2168  Log-loss: 0.6225

Ensemble summary for Cycle 3 (Cat:full | XGB:static | LGB:dynamic)
  CatBoost weight: 0.80
  XGBoost weight:  0.05
  LightGBM weight:0.15
  Threshold: 0.48
  FP+FN: 911.0 | MCC: 0.467 | Brier: 0.183

============================================================
Stage 1 best cycle selection
============================================================
Best cycle: Cycle 1 (Cat:static | XGB:dynamic | LGB:full) (index 1)
FP+FN=873.0 | MCC=0.489 | Brier=0.179

============================================================
STAGE 2: Final training with tiny holdout
============================================================

Warning: 7 features missing

Applying zero-to-NaN conversion for invalid zeros...
Replaced 2,225 invalid zeros with NaN

Train: (17055, 36) | Test: (98, 36)
Train class balance: {0: 9012, 1: 8043}
Static features (auto + overrides): 17
Dynamic features (auto + overrides): 19
Static feature list (with ordering preserved):
   1. gee_api_weighted_mm
   2. gee_aspect_mean
   3. gee_elevation_mean
   4. gee_flashiness_index
   5. gee_gsw_occurrence_mean
   6. gee_imerg_intensity_7d_mm_per_day
   7. gee_imerg_max_daily_7d_mm
   8. gee_imerg_sum_7d_before_mm
   9. gee_merit_upa_mean
  10. gee_ndbi_mean_30d
  11. gee_ndvi_mean_30d
  12. gee_ndwi_mean_30d
  13. gee_saturation_proxy
  14. gee_slope_mean
  15. gee_smap_subsurface_soil_moisture
  16. gee_smap_surface_soil_moisture
  17. gee_twi
Dynamic feature list (with ordering preserved):
   1. gee_antecedent_moisture_proxy
   2. gee_flashiness_index_7d
   3. gee_imerg_intensity_3d_mm_per_day
   4. gee_imerg_max_1h_intensity_mm
   5. gee_imerg_max_3h_intensity_mm
   6. gee_imerg_max_6h_intensity_mm
   7. gee_imerg_sum_24h_mm
   8. gee_imerg_sum_3d_before_mm
   9. gee_precip_x_slope
  10. gee_runoff_potential
  11. gee_smap_soil_moisture_anomaly
  12. glofas_forecast_10th_percentile
  13. glofas_forecast_90th_percentile
  14. glofas_forecast_control
  15. glofas_forecast_mean
  16. glofas_forecast_median
  17. glofas_forecast_std_dev
  18. imerg_max_1h_intensity_mm
  19. imerg_mean_1h_intensity_mm
Class imbalance ratio (Stage 2 train): 1.12

============================================================
TRAINING: CatBoost (static) - final
============================================================
Running cross-validation (10 folds)...

Cross-Validation Results (10 folds):
  ROC-AUC:   0.8160 ± 0.0088
  Recall:    0.7613 ± 0.0105
  Precision: 0.7177 ± 0.0097
  Balanced Acc: 0.7469 ± 0.0078
  MCC:       0.4931 ± 0.0156
  -(FP+FN):  -433.0000 ± 13.4495
  F1.0 Score: 0.7388 ± 0.0079
  F1.5 Score: 0.7473 ± 0.0084
  F2.0 Score: 0.7521 ± 0.0090
  F2.5 Score: 0.7549 ± 0.0094
  F3.0 Score: 0.7567 ± 0.0097

Generating out-of-fold predictions and fitting isotonic calibrator...

Test Set Results (threshold=0.42 minimizing FP+FN):
  ROC-AUC:        0.8566
  Balanced Acc:   0.7906
  MCC:            0.5844
  Total Error:    21
  Precision:      0.7273  Recall: 0.8696
  Confusion Matrix (Test): TP=40  FP=15  TN=37  FN=6
  Rates: TPR=0.8696  TNR=0.7115  FPR=0.2885  FNR=0.1304
  Brier:          0.1565  Log-loss: 0.4802

============================================================
TRAINING: XGBoost (dynamic) - final
============================================================
Running cross-validation (10 folds)...

Cross-Validation Results (10 folds):
  ROC-AUC:   0.7035 ± 0.0109
  Recall:    0.6780 ± 0.0175
  Precision: 0.6087 ± 0.0128
  Balanced Acc: 0.6444 ± 0.0123
  MCC:       0.2888 ± 0.0246
  -(FP+FN):  -609.7000 ± 21.2553
  F1.0 Score: 0.6414 ± 0.0124
  F1.5 Score: 0.6550 ± 0.0137
  F2.0 Score: 0.6628 ± 0.0148
  F2.5 Score: 0.6675 ± 0.0156
  F3.0 Score: 0.6703 ± 0.0161

Generating out-of-fold predictions and fitting isotonic calibrator...

Test Set Results (threshold=0.46 minimizing FP+FN):
  ROC-AUC:        0.7429
  Balanced Acc:   0.7145
  MCC:            0.4282
  Total Error:    28
  Precision:      0.6875  Recall: 0.7174
  Confusion Matrix (Test): TP=33  FP=15  TN=37  FN=13
  Rates: TPR=0.7174  TNR=0.7115  FPR=0.2885  FNR=0.2826
  Brier:          0.2050  Log-loss: 0.5928

============================================================
TRAINING: LightGBM (full) - final
============================================================
Running cross-validation (10 folds)...

Cross-Validation Results (10 folds):
  ROC-AUC:   0.8102 ± 0.0070
  Recall:    0.7536 ± 0.0096
  Precision: 0.7097 ± 0.0089
  Balanced Acc: 0.7392 ± 0.0076
  MCC:       0.4777 ± 0.0151
  -(FP+FN):  -446.2000 ± 13.0962
  F1.0 Score: 0.7309 ± 0.0075
  F1.5 Score: 0.7395 ± 0.0079
  F2.0 Score: 0.7444 ± 0.0083
  F2.5 Score: 0.7472 ± 0.0087
  F3.0 Score: 0.7489 ± 0.0089

Generating out-of-fold predictions and fitting isotonic calibrator...

Test Set Results (threshold=0.62 minimizing FP+FN):
  ROC-AUC:        0.8298
  Balanced Acc:   0.7768
  MCC:            0.5845
  Total Error:    21
  Precision:      0.8788  Recall: 0.6304
  Confusion Matrix (Test): TP=29  FP=4  TN=48  FN=17
  Rates: TPR=0.6304  TNR=0.9231  FPR=0.0769  FNR=0.3696
  Brier:          0.1685  Log-loss: 0.5009

------------------------------------------------------------
Stage 2 ensemble (tiny holdout)
Static weight (CatBoost): 0.45
Dynamic weight (XGBoost): 0.05
LightGBM weight:          0.50
Threshold (fixed): 0.51
F2.0: 0.7792  |  ROC-AUC: 0.8637  |  PR-AUC: 0.8516
Precision: 0.7660  |  Recall: 0.7826  |  MCC: 0.5705
Brier: 0.1575  |  Log-loss: 0.4799
Confusion Matrix: TP=36  FP=11  TN=41  FN=10

✅ Saved final ensemble model to ./ensemble_outputs\final_ensemble.pkl
Traceback (most recent call last):
  File "C:\Users\arham\CascadeProjects\Xgboost\3.py", line 2078, in <module>
    results = main(data_dir)
              ^^^^^^^^^^^^^^
  File "C:\Users\arham\CascadeProjects\Xgboost\3.py", line 1515, in main
    'model': stage1_info['cat_results']['model_name'],
             ~~~~~~~~~~~^^^^^^^^^^^^^^^
KeyError: 'cat_results'

C:\Users\arham\CascadeProjects\Xgboost>